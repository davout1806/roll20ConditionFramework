<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Fc Conditions By Token Test</title>
    <link rel="stylesheet" href="lib/qunit.css">
    <script src="lib/qunit.js"></script>
    <script src="../libs/underscore.js"></script>
    <script src="../main/testing/Roll20Mock.js"></script>
    <script src="../main/prod/Utils.js"></script>
    <script src="../main/prod/ConditionsByToken.js"></script>
    <script src="../main/prod/ConditionsFc.js"></script>
    <script>
        module ("Conditions",{
            setup: function() {
                state.Davout.TokensWithConditionObj = {};
                mock.clearCalls();
            }
        });

        test("Test: modifier with add & remove condition", function () {
            var tokenId = "1";

            equal(Davout.ConditionObj.getModifierFor(tokenId, "Str"), 0);
            Davout.ConditionObj.addConditionTo(tokenId, "Fatigued", "Orc");

            equal(Davout.ConditionObj.getModifierFor(tokenId, "Str"), -2);
            equal(mock.logCallCount(), 1);
            equal(mock.sendChatCount(), 1);
            equal(mock.getLogCall(0), "Added: condition Fatigued to Orc");
            equal(mock.getSendChat(0), "API:/w gm Condition Fatigued was added to Orc");

            Davout.ConditionObj.removeConditionFrom(tokenId, "Fatigued");
            equal(mock.logCallCount(), 2);
            equal(mock.sendChatCount(), 2);
            equal(mock.getLogCall(1), "Removed: condition Fatigued removed from Orc");
            equal(mock.getSendChat(1), "API:/w gm Condition Fatigued was removed from Orc");

            equal(Davout.ConditionObj.getModifierFor(tokenId, "Str"), 0);
        });

        test("Prohibited action+condition combo", function () {
            var tokenId = "1";

            equal(Davout.ConditionObj.isProhibited(tokenId, "Craft"), false);
            Davout.ConditionObj.addConditionTo(tokenId, "Blinded", "Orc");
            equal(Davout.ConditionObj.isProhibited(tokenId, "Craft"), true);

            equal(mock.logCallCount(), 1);
            equal(mock.sendChatCount(), 1);
            equal(mock.getLogCall(0), "Added: condition Blinded to Orc");
            equal(mock.getSendChat(0), "API:/w gm Condition Blinded was added to Orc");

            Davout.ConditionObj.removeConditionFrom(tokenId, "Blinded");
            equal(mock.logCallCount(), 2);
            equal(mock.sendChatCount(), 2);
            equal(mock.getLogCall(1), "Removed: condition Blinded removed from Orc");
            equal(mock.getSendChat(1), "API:/w gm Condition Blinded was removed from Orc");

            equal(Davout.ConditionObj.isProhibited(tokenId, "Craft"), false);
        });

        test("Stackable", function (){
            var tokenId = "1";
            Davout.ConditionObj.addConditionTo(tokenId, "Fatigued", "Orc");
            Davout.ConditionObj.addConditionTo(tokenId, "Fatigued", "Orc");

            equal(Davout.ConditionObj.getModifierFor(tokenId, "Str"), -4);
            equal(mock.logCallCount(), 2);
            equal(mock.sendChatCount(), 2);
            equal(mock.getLogCall(0), "Added: condition Fatigued to Orc");
            equal(mock.getSendChat(0), "API:/w gm Condition Fatigued was added to Orc");
            equal(mock.getLogCall(1), "Added: condition Fatigued-II to Orc");
            equal(mock.getSendChat(1), "API:/w gm Condition Fatigued was added to Orc causing condition: Fatigued-II");

            Davout.ConditionObj.removeConditionFrom(tokenId, "Fatigued");
            equal(mock.getLogCall(2), "Removed: condition Fatigued-II removed from Orc");
            equal(mock.getSendChat(2), "API:/w gm Condition Fatigued-II was removed from Orc");
        });

        test("Prevent duplicate condition if not stackable.", function(){
            var tokenId = "1";
            Davout.ConditionObj.addConditionTo(tokenId, "Blinded", "Orc");
            Davout.ConditionObj.addConditionTo(tokenId, "Blinded", "Orc");

            equal(mock.logCallCount(), 1);
            equal(mock.sendChatCount(), 2);
            equal(mock.getLogCall(0), "Added: condition Blinded to Orc");
            equal(mock.getSendChat(0), "API:/w gm Condition Blinded was added to Orc");
            equal(mock.getSendChat(1), "API:/w gm Orc already has the non-stackable condition Blinded");
        });
    </script>
</head>
<body>
<div id="qunit"></div>
<div id="qunit-fixture">

</div>
</body>
</html>